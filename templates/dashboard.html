<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard | Clima SJC</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background: #f6f8fb; }
    .card-soft {
      border: 0;
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(16, 24, 40, 0.08);
    }
    .muted { color: #667085; }
    .pill {
      font-size: .85rem;
      border-radius: 999px;
      padding: .35rem .6rem;
      background: #eef2ff;
      color: #3b5bfd;
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      font-weight: 600;
    }
    .kpi {
      font-size: 1.7rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }
    .kpi-sub { font-size: .9rem; }
    .table thead th { border-bottom: 0; }
    .chart-wrap { height: 320px; }
    footer { color: #98a2b3; }
    .navbar-brand { font-weight: 700; letter-spacing: -0.02em; }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-dark navbar-dark">
    <div class="container py-2">
      <span class="navbar-brand">ğŸŒ¤ï¸ Clima SJC</span>
      <div class="ms-auto d-flex align-items-center gap-2">
        <span class="pill">ğŸš€ ProduÃ§Ã£o</span>
        <a class="btn btn-sm btn-outline-light" href="/clima/ultimos" target="_blank">API</a>
      </div>
    </div>
  </nav>

  <main class="container my-4 my-lg-5">
    <!-- Header -->
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-2 mb-4">
      <div>
        <h1 class="h3 mb-1">Dashboard de Monitoramento</h1>
        <div class="muted">SÃ£o JosÃ© dos Campos â€¢ Coletas automÃ¡ticas no PostgreSQL</div>
      </div>
      <div class="d-flex gap-2">
      <button id="btnColetar" class="btn btn-primary" type="button">ğŸ”„ Coletar agora</button>
        <a class="btn btn-outline-secondary" href="/clima/resumo" target="_blank">ğŸ“Œ Resumo (JSON)</a>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row g-3 g-lg-4 mb-4">
      <div class="col-12 col-md-6 col-lg-3">
        <div class="card card-soft p-4">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="muted kpi-sub">Total de registros</div>
              <div class="kpi">{{ resumo.total_registros }}</div>
            </div>
            <div class="fs-3">ğŸ—‚ï¸</div>
          </div>
          <div class="muted mt-2">Ãšltimas 5 coletas na tabela abaixo</div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <div class="card card-soft p-4">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="muted kpi-sub">MÃ©dia de temperatura</div>
              <div class="kpi">{{ resumo.media_temp }} <span class="fs-5">Â°C</span></div>
            </div>
            <div class="fs-3">ğŸŒ¡ï¸</div>
          </div>
          <div class="muted mt-2">Base: todos os registros salvos</div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <div class="card card-soft p-4">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="muted kpi-sub">Menor temperatura</div>
              <div class="kpi">{{ resumo.menor_temp }} <span class="fs-5">Â°C</span></div>
            </div>
            <div class="fs-3">â„ï¸</div>
          </div>
          <div class="muted mt-2">HistÃ³rico completo</div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-3">
        <div class="card card-soft p-4">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="muted kpi-sub">Maior temperatura</div>
              <div class="kpi">{{ resumo.maior_temp }} <span class="fs-5">Â°C</span></div>
            </div>
            <div class="fs-3">ğŸ”¥</div>
          </div>
          <div class="muted mt-2">HistÃ³rico completo</div>
        </div>
      </div>
    </div>

    <!-- Chart -->
    <div class="card card-soft p-4 mb-4">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-3">
        <div>
          <h2 class="h5 mb-1">ğŸ“ˆ SÃ©rie temporal</h2>
          <div class="muted">Temperatura (Â°C) e vento (km/h) â€” Ãºltimas 50 coletas</div>
        </div>
        <span class="pill">AtualizaÃ§Ã£o automÃ¡tica via cron</span>
      </div>

      <div class="chart-wrap">
        <canvas id="climaChart"></canvas>
      </div>
    </div>

    <!-- Table -->
    <div class="card card-soft p-4">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2 mb-3">
        <h2 class="h5 mb-0">ğŸ§¾ Ãšltimos registros</h2>
        <div class="muted">Ordenado por data (mais recente primeiro)</div>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Data</th>
              <th>Temperatura</th>
              <th>Vento</th>
            </tr>
          </thead>
          <tbody>
            {% for item in ultimos %}
            <tr>
              <td>
                <span class="badge text-bg-dark">{{ item.data_coleta }}</span>
              </td>
              <td>
                <span class="badge text-bg-primary">{{ item.temperatura }} Â°C</span>
              </td>
              <td>
                <span class="badge text-bg-secondary">{{ item.vento_kmh }} km/h</span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <footer class="mt-4 text-center">
      <div>Feito com Flask + PostgreSQL + Render + GitHub Actions</div>
    </footer>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    async function carregarGrafico() {
      const resp = await fetch("/clima/serie");
      const dados = await resp.json();

      const labels = dados.map(x => new Date(x.data_coleta).toLocaleString("pt-BR"));
      const temp = dados.map(x => Number(x.temperatura));
      const vento = dados.map(x => Number(x.vento_kmh));

      const ctx = document.getElementById("climaChart");

      new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Temperatura (Â°C)", data: temp, tension: 0.35 },
            { label: "Vento (km/h)", data: vento, tension: 0.35 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: { legend: { position: "top" } },
          scales: {
            x: { ticks: { maxTicksLimit: 8 } }
          }
        }
      });
    }

    carregarGrafico();
  </script>

<script>
  const btn = document.getElementById("btnColetar");

  btn.addEventListener("click", async () => {
    try {
      btn.disabled = true;
      btn.textContent = "â³ Coletando...";

      const resp = await fetch("/clima/coletar");
      if (!resp.ok) throw new Error("Falha ao coletar");

      // opcional: ler o json sÃ³ pra garantir que veio
      await resp.json();

      // recarrega o dashboard pra atualizar cards/tabela
      window.location.reload();
    } catch (e) {
      alert("Erro ao coletar. Tenta de novo.");
      console.error(e);
    } finally {
      btn.disabled = false;
      btn.textContent = "ğŸ”„ Coletar agora";
    }
  });
</script>
</body>
</html>